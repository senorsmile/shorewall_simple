#
# Shorewall -- /etc/shorewall/start
#
# Add commands below that you want to be executed after shorewall has
# been started, reloaded or restarted.
#
# See https://shorewall.org/shorewall_extension_scripts.htm for additional
# information.
#
###############################################################################
{# #}
{#--#}{% if shorewall_docker_fix_needed is defined and shorewall_docker_fix_needed %}
#-----------------------
### custom rules for docker (if shorewall < v5.0.6)
#-----------------------
if [ -f /etc/shorewall/docker_rules ]; then
    iptables-restore -n </etc/shorewall/docker_rules
    run_iptables -t nat -I PREROUTING -m addrtype --dst-type LOCAL -j DOCKER
    run_iptables -t nat -I OUTPUT ! -d 127.0.0.0/8 -m addrtype --dst-type LOCAL -j DOCKER
    run_iptables -I FORWARD -o docker0 -j DOCKER
    run_iptables -I FORWARD -o docker0 -m conntrack --ctstate RELATED,ESTABLISHED -j ACCEPT
    run_iptables -I FORWARD -i docker0 ! -o docker0 -j ACCEPT
    run_iptables -I FORWARD -i docker0 -o docker0 -j ACCEPT

    rm -f /etc/shorewall/docker_rules
fi

{#--#}{% endif %}
{# #}

{% if shorewall_start_script is defined %}
#-----------------------
### custom rules from ansible variables
#-----------------------
{{ shorewall_start_script }}

{% endif %}
return 0
